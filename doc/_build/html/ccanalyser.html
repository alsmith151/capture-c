
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>capturec/ccanalyser.py &#8212; capture-c 0.0.1 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to capture-c’s documentation!" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="capturec-ccanalyser-py">
<h1>capturec/ccanalyser.py<a class="headerlink" href="#capturec-ccanalyser-py" title="Permalink to this headline">¶</a></h1>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">usage: capturec/ccanalyser.py [-h] [-i INPUT_BAM] [-a ANNOTATIONS]</span>
<span class="go">                              [--output_prefix OUTPUT_PREFIX]</span>
<span class="go">                              [--stats_output STATS_OUTPUT]</span>
</pre></div>
</div>
<dl class="option">
<dt id="cmdoption-capturec-ccanalyser-py-h">
<code class="sig-name descname">-h</code><code class="sig-prename descclassname"></code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--help</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-capturec-ccanalyser-py-h" title="Permalink to this definition">¶</a></dt>
<dd><p>show this help message and exit</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-capturec-ccanalyser-py-i">
<code class="sig-name descname">-i</code><code class="sig-prename descclassname"> &lt;input_bam&gt;</code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--input_bam</code><code class="sig-prename descclassname"> &lt;input_bam&gt;</code><a class="headerlink" href="#cmdoption-capturec-ccanalyser-py-i" title="Permalink to this definition">¶</a></dt>
<dd><p>BAM file to parse</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-capturec-ccanalyser-py-a">
<code class="sig-name descname">-a</code><code class="sig-prename descclassname"> &lt;annotations&gt;</code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--annotations</code><code class="sig-prename descclassname"> &lt;annotations&gt;</code><a class="headerlink" href="#cmdoption-capturec-ccanalyser-py-a" title="Permalink to this definition">¶</a></dt>
<dd><p>Tab-delimited text file containing annotation for each read in bam file</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-capturec-ccanalyser-py-output-prefix">
<code class="sig-name descname">--output_prefix</code><code class="sig-prename descclassname"> &lt;output_prefix&gt;</code><a class="headerlink" href="#cmdoption-capturec-ccanalyser-py-output-prefix" title="Permalink to this definition">¶</a></dt>
<dd><p>Output file prefix</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-capturec-ccanalyser-py-stats-output">
<code class="sig-name descname">--stats_output</code><code class="sig-prename descclassname"> &lt;stats_output&gt;</code><a class="headerlink" href="#cmdoption-capturec-ccanalyser-py-stats-output" title="Permalink to this definition">¶</a></dt>
<dd><p>stats files output prefix</p>
</dd></dl>

</div>
<span class="target" id="module-capturec.ccanalyser"></span><dl class="class">
<dt id="capturec.ccanalyser.SliceFilter">
<em class="property">class </em><code class="sig-prename descclassname">capturec.ccanalyser.</code><code class="sig-name descname">SliceFilter</code><span class="sig-paren">(</span><em class="sig-param">slices</em><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.SliceFilter" title="Permalink to this definition">¶</a></dt>
<dd><p>Class containing methods for filtering slices and reporting
slice/fragment statistics.</p>
<dl class="simple">
<dt>Attributes:</dt><dd><p>slices: DataFrame containing aligned reads and annotations.</p>
</dd>
</dl>
<p>Slices DataFrame must have the following columns:</p>
<ul class="simple">
<li><p>read_name: Unique aligned read identifier (e.g. XZKG:889:11|flashed|1)</p></li>
<li><p>parent_read: Identifier shared by slices from same fragment (e.g.XZKG:889:11)</p></li>
<li><p>pe: Read combined by FLASh or not (i.e. “flashed” or “pe”)</p></li>
<li><p>mapped: Alignment is mapped (e.g. 0/1)</p></li>
<li><p>slice: Slice number (e.g. 0)</p></li>
<li><p>capture: Capture site intersecting slice (e.g. Slc25A37)</p></li>
<li><p>capture_count: Number of capture probes overlapping slice (e.g. 1)</p></li>
<li><p>exclusion: Read present in excluded region (e.g. Slc25A37)</p></li>
<li><p>exclusion_count: Number of excluded regions overlapping slice (e.g. 1)</p></li>
<li><p>blacklist: Read present in excluded region (e.g. 0)</p></li>
<li><p>coordinates: Genome coordinates (e.g. chr1|1000|2000)</p></li>
</ul>
<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.captures">
<em class="property">property </em><code class="sig-name descname">captures</code><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.captures" title="Permalink to this definition">¶</a></dt>
<dd><p>Extracts capture slices from slices dataframe
i.e. slices that do not have a null capture name</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>Dataframe containg all capture slices</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.fragments">
<em class="property">property </em><code class="sig-name descname">fragments</code><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.fragments" title="Permalink to this definition">¶</a></dt>
<dd><p>Summarises slices at the fragment level.</p>
<blockquote>
<div><p>Uses pandas groupby to aggregate slices by their parental read name
(shared by all slices from the same fragment). Also determines the
number of reporter slices for each fragment.</p>
</div></blockquote>
<dl class="simple">
<dt>Returns:</dt><dd><p>Dataframe of slices aggregated by fragment</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.modify_re_frag">
<em class="property">static </em><code class="sig-name descname">modify_re_frag</code><span class="sig-paren">(</span><em class="sig-param">frag: str</em>, <em class="sig-param">adjust=1</em><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.modify_re_frag" title="Permalink to this definition">¶</a></dt>
<dd><p>Increases/Decreases the RE frag number.</p>
<p>e.g. modify_re_frag(DpnII_chr10_5, adjust=1) -&gt; DpnII_chr10_6</p>
<dl class="simple">
<dt>Args:</dt><dd><p>frag: Name of restriction fragment (str)
adjust: Adjust fragment identifier number by value</p>
</dd>
<dt>Returns:</dt><dd><p>Modified fragment name (str)</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.remove_duplicate_re_frags">
<code class="sig-name descname">remove_duplicate_re_frags</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.remove_duplicate_re_frags" title="Permalink to this definition">¶</a></dt>
<dd><p>Prevent the same restriction fragment being counted more than once (Uncommon).
i.e. –RE_FRAG1——Capture——-RE_FRAG1—-</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>SliceFilter</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.remove_duplicate_slices">
<code class="sig-name descname">remove_duplicate_slices</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.remove_duplicate_slices" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove all slices if the slice coordinates and slice order are shared
with another fragment i.e. are PCR duplicates (Common).</p>
<dl class="simple">
<dt>e.g</dt><dd><p>coordinates</p>
</dd>
</dl>
<div class="line-block">
<div class="line">Frag 1:  chr1:1000-1250 chr1:1500-1750</div>
<div class="line">Frag 2:  chr1:1000-1250 chr1:1500-1750</div>
<div class="line">Frag 3:  chr1:1050-1275 chr1:1600-1755</div>
<div class="line">Frag 4:  chr1:1500-1750 chr1:1000-1250</div>
</div>
<p>Frag 2 removed. Frag 1,3,4 retained</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>SliceFilter</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.remove_duplicate_slices_pe">
<code class="sig-name descname">remove_duplicate_slices_pe</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.remove_duplicate_slices_pe" title="Permalink to this definition">¶</a></dt>
<dd><p>Removes PCR duplicates from non-flashed (PE) fragments (Common).
Sequence quality is often lower at the 3’ end of reads leading to variance in mapping coordinates.
PCR duplicates are removed by checking that the fragment start and end are not duplicated in the dataframe.</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>SliceFilter</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.remove_exluded_and_blacklisted_slices">
<code class="sig-name descname">remove_exluded_and_blacklisted_slices</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.remove_exluded_and_blacklisted_slices" title="Permalink to this definition">¶</a></dt>
<dd><p>Removes any slices in the exclusion region (default 1kb) and a blacklist (if supplied) (V. Common)</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>SliceFilter</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.remove_multi_capture_fragments">
<code class="sig-name descname">remove_multi_capture_fragments</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.remove_multi_capture_fragments" title="Permalink to this definition">¶</a></dt>
<dd><p>Removes all slices (i.e. the entire fragment) if more than
one capture probe is present i.e. double captures (V. Common)</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>SliceFilter</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.remove_multicapture_reporters">
<code class="sig-name descname">remove_multicapture_reporters</code><span class="sig-paren">(</span><em class="sig-param">n_adjacent=1</em><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.remove_multicapture_reporters" title="Permalink to this definition">¶</a></dt>
<dd><div class="line-block">
<div class="line">Deals with an odd situation in which a reporter spanning two adjacent capture sites is not removed.</div>
<div class="line">e.g.</div>
<div class="line">——Capture 1—-/——Capture 2——</div>
<div class="line-block">
<div class="line">—–REP——–</div>
<div class="line"><br /></div>
</div>
<div class="line">In this case the “reporter” slice is not considered either a capture or exclusion.</div>
</div>
<div class="line-block">
<div class="line">These cases are dealt with by explicitly removing reporters on restriction fragments</div>
<div class="line">adjacent to capture sites.</div>
</div>
<div class="line-block">
<div class="line">The number of adjacent RE fragments can be adjusted with n_adjacent.</div>
</div>
<div class="line-block">
<div class="line">Returns:</div>
<div class="line-block">
<div class="line">SliceFilter</div>
</div>
</div>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.remove_non_reporter_fragments">
<code class="sig-name descname">remove_non_reporter_fragments</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.remove_non_reporter_fragments" title="Permalink to this definition">¶</a></dt>
<dd><p>Removes all slices (i.e. the entire fragment) if it has no reporter slices present (Common)</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>SliceFilter</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.remove_orphan_slices">
<code class="sig-name descname">remove_orphan_slices</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.remove_orphan_slices" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove fragments with only one aligned slice (Common)</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>SliceFilter</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.remove_unmapped_slices">
<code class="sig-name descname">remove_unmapped_slices</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.remove_unmapped_slices" title="Permalink to this definition">¶</a></dt>
<dd><p>Removes slices marked as unmapped (Uncommon)</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>SliceFilter</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.reporters">
<em class="property">property </em><code class="sig-name descname">reporters</code><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.reporters" title="Permalink to this definition">¶</a></dt>
<dd><p>Extracts reporter slices from slices dataframe
i.e. non-capture slices</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>Dataframe containg all non-capture slices</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="capturec.ccanalyser.SliceFilter.slice_stats">
<em class="property">property </em><code class="sig-name descname">slice_stats</code><a class="headerlink" href="#capturec.ccanalyser.SliceFilter.slice_stats" title="Permalink to this definition">¶</a></dt>
<dd><p>Gets statisics at a slice level.</p>
<p>Aggregates slices to determine the number of:
-unique slices
-unique fragments
-unique capture sites
-capture slices
-excluded slices
-blacklisted slices</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>Dataframe containing slice statistics</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="capturec.ccanalyser.aggregate_by_capture_site">
<code class="sig-prename descclassname">capturec.ccanalyser.</code><code class="sig-name descname">aggregate_by_capture_site</code><span class="sig-paren">(</span><em class="sig-param">capture</em>, <em class="sig-param">reporter</em><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.aggregate_by_capture_site" title="Permalink to this definition">¶</a></dt>
<dd><p>Merges capture and reporter slices and aggregates dataframe by capture probe.</p>
<dl class="simple">
<dt>Args:</dt><dd><p>capture: Datframe containing capture slices i.e. SliceFilter.captures
reporter: Dataframe containing reporter slices i.e. SliceFilter.reporters</p>
</dd>
<dt>Returns:</dt><dd><p>pandas.core.groupby.generic.DataFrameGroupBy object
containing captures and reporters grouped by capture_probe.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="capturec.ccanalyser.filter_slices">
<code class="sig-prename descclassname">capturec.ccanalyser.</code><code class="sig-name descname">filter_slices</code><span class="sig-paren">(</span><em class="sig-param">df_slices</em><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.filter_slices" title="Permalink to this definition">¶</a></dt>
<dd><p>Performs filtering of slices with the SliceFilter class.
Also outputs statitsics after each major filtering step.</p>
<dl class="simple">
<dt>Args:</dt><dd><dl class="simple">
<dt>df_slices: Dataframe. Must contain all of the columns required by</dt><dd><p>SliceFilter.</p>
</dd>
</dl>
</dd>
<dt>Returns:</dt><dd><p>SliceFilter instance</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="capturec.ccanalyser.get_timing">
<code class="sig-prename descclassname">capturec.ccanalyser.</code><code class="sig-name descname">get_timing</code><span class="sig-paren">(</span><em class="sig-param">task_name=None</em><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.get_timing" title="Permalink to this definition">¶</a></dt>
<dd><p>Decorator:
Gets the time taken by the wrapped function</p>
</dd></dl>

<dl class="function">
<dt id="capturec.ccanalyser.merge_annotations">
<code class="sig-prename descclassname">capturec.ccanalyser.</code><code class="sig-name descname">merge_annotations</code><span class="sig-paren">(</span><em class="sig-param">df</em>, <em class="sig-param">annotations</em><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.merge_annotations" title="Permalink to this definition">¶</a></dt>
<dd><p>Combines annotations with the parsed bam file output.</p>
<p>Uses pandas outer join on the indexes to merge annotations
e.g. number of capture probe overlaps.</p>
<p>Annotation tsv must have the index as the first column and this index
must have intersecting keys with the first dataframe’s index.</p>
<dl class="simple">
<dt>Args:</dt><dd><p>df: pd.Dataframe to merge with annotations
annotations: Filename of .tsv to read and merge with df</p>
</dd>
<dt>Returns:</dt><dd><p>Merged dataframe</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="capturec.ccanalyser.parse_alignment">
<code class="sig-prename descclassname">capturec.ccanalyser.</code><code class="sig-name descname">parse_alignment</code><span class="sig-paren">(</span><em class="sig-param">aln</em><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.parse_alignment" title="Permalink to this definition">¶</a></dt>
<dd><p>Parses reads from a bam file into a list.</p>
<dl class="simple">
<dt>Args:</dt><dd><p>aln: pysam.AlignmentFile</p>
</dd>
<dt>Returns:</dt><dd><p>List containing:
-read name
-parent reads
-flashed status
-slice number
-mapped status
-multimapping status
-chromosome number (e.g. chr10)
-start (e.g. 1000)
-end (e.g. 2000)
-coords e.g. (chr10:1000-2000)</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="capturec.ccanalyser.parse_bam">
<code class="sig-prename descclassname">capturec.ccanalyser.</code><code class="sig-name descname">parse_bam</code><span class="sig-paren">(</span><em class="sig-param">bam</em><span class="sig-paren">)</span><a class="headerlink" href="#capturec.ccanalyser.parse_bam" title="Permalink to this definition">¶</a></dt>
<dd><p>Uses parse_alignment function convert bam file to a dataframe.</p>
<dl class="simple">
<dt>Args:</dt><dd><p>bam: File name of bam file to process.</p>
</dd>
<dt>Returns:</dt><dd><p>Dataframe with columns:
-‘read_name’
-‘parent_read’
-‘pe’
-‘slice’
-‘mapped’
-‘multimapped’
-‘chrom’
-‘start’
-‘end’
-‘coordinates’</p>
</dd>
</dl>
</dd></dl>



          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">capture-c</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">capturec/ccanalyser.py</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Welcome to capture-c’s documentation!</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, asmith, dsims.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/ccanalyser.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>